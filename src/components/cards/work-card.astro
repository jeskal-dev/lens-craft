---
import type { CollectionEntry } from "astro:content";
import WorkDialog from "../dialogs/work-dialog.astro";

interface Props {
  work: CollectionEntry<"gallery">;
  class?: string;
  index: number;
}

const { work, class: className, index } = Astro.props;

const imageConfigs = {
  wedding: { quality: 85, width: 1200, aspect: "4/3" },
  portrait: { quality: 90, width: 1000, aspect: "1/1" },
  landscape: { quality: 80, width: 1600, aspect: "16/9" },
  event: { quality: 85, width: 1200, aspect: "3/2" },
};

const getImageConfig = (category: string) => {
  const defaultConfig = { quality: 85, width: 1200, aspect: "4/3" };

  // Normalizar categoría para coincidir
  const cat = category.toLowerCase();
  if (cat.includes("boda") || cat.includes("wedding"))
    return imageConfigs.wedding;
  if (cat.includes("retrato") || cat.includes("portrait"))
    return imageConfigs.portrait;
  if (cat.includes("paisaje") || cat.includes("landscape"))
    return imageConfigs.landscape;
  if (cat.includes("evento") || cat.includes("event"))
    return imageConfigs.event;

  return defaultConfig;
};

const delay = (index + 1) * 200;

const category = work.data.category;
const imgConfig = getImageConfig(category);
---

<div
  data-gallery-item
  data-category={category}
  data-work-card
  data-index={index}
  class={`${className} motion-translate-y-in-100 motion-opacity-in-0`}
>
  <article
    class="group relative overflow-hidden rounded-3xl cursor-pointer transform-gpu transition-all duration-500 h-full"
  >
    <!-- Image Container con loading optimizado -->
    <div class="w-full h-full overflow-hidden bg-gray-100 dark:bg-gray-800">
      <picture>
        <!-- WebP optimizado -->
        <source
          srcset={`
            ${work.data.image}?w=${imgConfig.width}&q=${imgConfig.quality}&fm=webp 1x,
            ${work.data.image}?w=${imgConfig.width * 2}&q=${imgConfig.quality}&fm=webp 2x
          `}
          type="image/webp"
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
        />
        <!-- Fallback JPEG -->
        <img
          src={`${work.data.image}?w=${imgConfig.width}&q=${imgConfig.quality}`}
          srcset={`
            ${work.data.image}?w=${imgConfig.width}&q=${imgConfig.quality} 1x,
            ${work.data.image}?w=${imgConfig.width * 2}&q=${imgConfig.quality} 2x
          `}
          alt={`${work.data.title} - Fotografía de ${category} por estudio fotográfico`}
          width={imgConfig.width}
          height={Math.round(
            imgConfig.width /
              (imgConfig.aspect === "4/3"
                ? 4 / 3
                : imgConfig.aspect === "16/9"
                  ? 16 / 9
                  : imgConfig.aspect === "1/1"
                    ? 1
                    : 3 / 2)
          )}
          loading={index < 3 ? "eager" : "lazy"}
          decoding="async"
          class="w-full h-full object-cover transition-all duration-1000 group-hover:scale-110 group-hover:rotate-1 motion-scale-in-95"
        />
      </picture>

      <!-- Placeholder sutil mientras carga -->
      <div
        class="absolute inset-0 bg-gradient-to-br from-gray-200/20 to-gray-300/10 dark:from-gray-700/20 dark:to-gray-800/10 animate-pulse opacity-0 group-hover:opacity-100 transition-opacity duration-300"
      >
      </div>
    </div>

    <!-- Content Overlay con animaciones mejoradas -->
    <div
      class="absolute inset-0 p-8 flex flex-col justify-end bg-gradient-to-t from-black/85 via-black/30 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500 motion-blur-in motion-duration-500"
    >
      <div
        class="translate-y-8 group-hover:translate-y-0 transition-all duration-700 space-y-3 motion-translate-y-in-20"
      >
        <div class="flex items-center gap-3">
          <span
            class="px-3 py-1 rounded-full bg-primary/20 backdrop-blur-md border border-primary/30 text-white text-[10px] font-bold uppercase tracking-widest motion-scale-in-95"
          >
            {work.data.category}
          </span>
          <span
            class="text-white/60 text-[10px] font-bold uppercase tracking-widest motion-opacity-in-0 motion-delay-100"
          >
            {new Date(work.data.date).getFullYear()}
          </span>
        </div>
        <h3
          class="text-white text-3xl md:text-3xl font-serif font-bold leading-tight motion-translate-y-in-10 motion-opacity-in-0 motion-delay-200"
        >
          {work.data.title}
        </h3>
        <div
          class="pt-4 flex items-center gap-2 text-white/80 text-sm font-medium"
        >
          <span
            class="motion-translate-x-in--10 motion-opacity-in-0 motion-delay-300"
            >Ver detalles</span
          >
          <span
            class="w-10 h-px bg-white/40 transition-all duration-700 group-hover:w-16 group-hover:bg-primary motion-scale-x-in-0 motion-delay-400"
          ></span>
        </div>
      </div>
    </div>

    <!-- Hover subtle border con animación -->
    <div
      class="absolute inset-4 border border-white/10 rounded-2xl pointer-events-none opacity-0 group-hover:opacity-100 transition-all duration-700 motion-border-width-in-0"
    >
    </div>

    <!-- Indicador de carga para imágenes -->
    <div class="sr-only" aria-live="polite" aria-busy="false" data-image-status>
      Cargando imagen {index + 1} de {category}
    </div>
  </article>

  <WorkDialog work={work} index={index} />
</div>

<script>
  // Configuración de animaciones inView
  function setupWorkCardAnimations() {
    const cards = document.querySelectorAll<HTMLElement>("[data-work-card]");

    if (!("IntersectionObserver" in window)) {
      // Fallback para navegadores antiguos
      cards.forEach((card) => {
        card.classList.add("motion-active");
      });
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const card = entry.target as HTMLElement;
          const index = card.dataset.index || "0";
          const delay = parseInt(index) * 100;

          if (entry.isIntersecting) {
            setTimeout(() => {
              card.classList.add("motion-active");
              observer.unobserve(card);
            }, delay);
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: "0px 0px -50px 0px",
      }
    );

    cards.forEach((card) => {
      observer.observe(card);
    });
  }

  // Optimización de imágenes
  function optimizeWorkCardImages() {
    const cards = document.querySelectorAll("[data-work-card]");

    cards.forEach((card, index) => {
      const img = card.querySelector("img");
      const statusElement = card.querySelector("[data-image-status]");

      if (!img) return;

      // Mejorar prioridad de carga para primeras imágenes
      if (index < 2) {
        img.fetchPriority = "high";
      }

      // Manejar eventos de carga
      img.addEventListener("load", () => {
        img.classList.add("motion-opacity-in-100");
        if (statusElement) {
          statusElement.textContent = "Imagen cargada";
          statusElement.setAttribute("aria-busy", "false");
        }
      });

      img.addEventListener("error", () => {
        console.warn(`Error cargando imagen en tarjeta ${index + 1}`);
        if (statusElement) {
          statusElement.textContent = "Error cargando imagen";
        }
      });
    });
  }

  // Inicializar
  function setupWorkCard() {
    const cards = document.querySelectorAll("[data-work-card]");

    // Configurar clicks para diálogos
    cards.forEach((card) => {
      const article = card.querySelector("article");
      const dialog = card.querySelector("dialog");

      if (!article || !dialog) return;

      article.addEventListener("click", () => {
        dialog.showModal();
        document.body.style.overflow = "hidden";
      });
    });

    // Configurar animaciones
    setupWorkCardAnimations();

    // Optimizar imágenes
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", optimizeWorkCardImages);
    } else {
      optimizeWorkCardImages();
    }
  }

  setupWorkCard();
  document.addEventListener("astro:after-swap", setupWorkCard);
</script>

<style>
  /* Optimizaciones de rendimiento para animaciones */
  .motion-active {
    --motion-opacity: 1;
    --motion-translate-y: 0;
    --motion-scale: 1;
    --motion-blur: 0;
  }

  /* Mejoras de rendimiento para transformaciones */
  .transform-gpu {
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  /* Animaciones suaves */
  @media (prefers-reduced-motion: no-preference) {
    [data-work-card] {
      animation-timeline: view();
      animation-range: entry 0% cover 40%;
    }
  }
</style>
