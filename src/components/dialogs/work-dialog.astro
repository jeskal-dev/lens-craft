---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
interface Props {
  work: CollectionEntry<"gallery">;
  index: number;
}

const { work, index } = Astro.props;
---

<dialog
  class="fixed inset-0 z-50 p-0 m-0 w-full h-full bg-transparent border-none backdrop:bg-black/80 backdrop:backdrop-blur-xl items-center justify-center transition-all duration-500 transition-discrete open:flex"
>
  <div
    class="modal-content relative w-[96vw] md:w-[88vw] max-w-6xl h-[92vh] md:h-[80vh] bg-zinc-950/95 border border-white/10 rounded-[2.5rem] overflow-hidden shadow-[0_0_80px_rgba(0,0,0,0.85)] flex flex-col md:flex-row"
  >
    <!-- Close Button (Floating & Pulsing) -->
    <button
      data-close-dialog
      class="absolute top-10 right-10 z-30 p-2 rounded-full bg-white/5 border border-white/10 text-white hover:bg-primary hover:scale-110 active:scale-95 transition-all duration-500 group overflow-hidden"
      aria-label="Cerrar modal"
    >
      <div
        class="absolute inset-0 bg-primary/20 scale-0 group-hover:scale-150 transition-transform duration-700 rounded-full blur-xl"
      >
      </div>
      <Icon
        name="lucide:x"
        class="size-4 relative z-10 group-hover:rotate-180 transition-transform duration-700"
      />
    </button>

    <!-- Cinematic Image (contenida + fondo difuminado) -->
    <div
      class="w-full md:w-3/5 h-[40vh] md:h-auto overflow-hidden relative isolate"
    >
      <!-- Fondo difuminado (misma imagen, cover, blur) -->
      <div
        class="absolute inset-0 scale-110 brightness-75 contrast-125 blur-2xl"
        style={`background-image:url('${work.data.image}'); background-size:cover; background-position:center;`}
      >
      </div>

      <!-- Imagen principal (contenida) -->
      <img
        src={work.data.image}
        alt={work.data.title}
        class="relative z-10 w-full h-full object-contain"
      />

      <!-- Overlay gradient -->
      <div
        class="absolute inset-0 bg-linear-to-r from-black/40 to-transparent pointer-events-none"
      >
      </div>

      <!-- Meta inferior (desktop) -->
      <div
        class="absolute inset-x-8 bottom-8 z-20 hidden md:flex items-center justify-between text-xs text-white/60 font-mono"
      >
        <span class="uppercase tracking-[0.25em] text-white/40">
          {work.data.category}
        </span>
        <span>{new Date(work.data.date).getFullYear()}</span>
      </div>
    </div>

    <!-- Content (Editorial Style) -->
    <div
      class="w-full md:w-2/5 p-10 md:p-16 flex flex-col justify-between bg-linear-to-b from-zinc-950 via-zinc-900 to-zinc-950 overflow-y-auto border-l border-white/5"
    >
      <div>
        <header class="mb-12">
          <div
            class="flex items-center gap-6 mb-8 translate-y-4 animate-in fade-in duration-700 slide-in-from-bottom-4"
          >
            <span
              class="px-5 py-2 rounded-full bg-white/5 border border-white/10 text-white text-[10px] font-bold uppercase tracking-[0.2em]"
            >
              {work.data.category}
            </span>
            <span
              class="w-2 h-2 rounded-full bg-primary/40 shadow-[0_0_10px_rgba(var(--primary-rgb),0.5)]"
            ></span>
            <span
              class="text-white/30 text-[10px] font-bold uppercase tracking-[0.2em]"
            >
              {
                new Date(work.data.date).toLocaleDateString("es-ES", {
                  month: "long",
                  year: "numeric",
                })
              }
            </span>
          </div>

          <h2
            class="text-5xl md:text-7xl font-serif font-extralight text-white mb-10 leading-[1.1] tracking-tight translate-y-4 animate-in fade-in duration-700 delay-150 slide-in-from-bottom-4"
          >
            {work.data.title}
          </h2>
        </header>

        <section
          class="space-y-10 translate-y-4 animate-in fade-in duration-700 delay-300 slide-in-from-bottom-4"
        >
          <div>
            <h4
              class="text-white/20 text-[10px] font-bold uppercase tracking-[0.4em] mb-4"
            >
              Concepto
            </h4>
            <p class="text-white/70 text-base leading-relaxed">
              {work.data.description}
            </p>
          </div>
        </section>
      </div>

      <footer
        class="mt-16 pt-10 border-t border-white/5 flex items-end justify-between translate-y-4 animate-in fade-in duration-1000 delay-500 slide-in-from-bottom-4"
      >
        <div>
          <h4
            class="text-white/20 text-[10px] font-bold uppercase tracking-[0.4em] mb-2"
          >
            Fotograf√≠a de
          </h4>
          <p class="text-3xl font-serif text-white/90">{work.data.author}</p>
        </div>

        <div class="flex flex-col items-end">
          <span
            class="text-[10px] text-white/20 uppercase tracking-[0.2em] mb-2"
            >ID Proyecto</span
          >
          <span class="text-xs font-mono text-white/40"
            >#LC-{index.toString().padStart(4, "0")}
          </span>
        </div>
      </footer>
    </div>
  </div>
</dialog>

<script>
  function setupWorkDialog() {
    const dialogs = document.querySelectorAll("dialog");

    dialogs.forEach((dialog) => {
      const closeBtn = dialog.querySelector("[data-close-dialog]");
      if (!closeBtn) return;

      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        closeDialog(dialog as HTMLDialogElement);
      });

      dialog.addEventListener("click", (e) => {
        if (e.target === dialog) {
          closeDialog(dialog as HTMLDialogElement);
        }
      });

      function closeDialog(el: HTMLDialogElement) {
        el.classList.add("closing");
        el.addEventListener(
          "animationend",
          () => {
            el.close();
            el.classList.remove("closing");
          },
          { once: true }
        );
      }

      dialog.addEventListener("close", () => {
        document.body.style.overflow = "";
      });
    });
  }

  setupWorkDialog();
  document.addEventListener("astro:after-swap", setupWorkDialog);
</script>

<style>
  dialog {
    opacity: 0;
    scale: 0.95;
    filter: blur(10px);
    transition:
      opacity 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
      scale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
      filter 0.6s ease-out,
      display 0.6s allow-discrete,
      overlay 0.6s allow-discrete;
  }

  dialog[open] {
    opacity: 1;
    scale: 1;
    filter: blur(0px);
  }

  @starting-style {
    dialog[open] {
      opacity: 0;
      scale: 0.95;
      filter: blur(10px);
    }
  }

  dialog::backdrop {
    background-color: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    transition:
      background-color 0.6s ease-out,
      backdrop-filter 0.6s ease-out,
      display 0.6s allow-discrete,
      overlay 0.6s allow-discrete;
  }

  dialog[open]::backdrop {
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(20px);
  }

  @starting-style {
    dialog[open]::backdrop {
      background-color: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
    }
  }

  dialog.closing {
    animation: modal-out 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  dialog.closing::backdrop {
    animation: backdrop-out 0.4s ease-in forwards;
  }

  @keyframes modal-out {
    to {
      opacity: 0;
      scale: 0.95;
      filter: blur(10px);
    }
  }

  @keyframes backdrop-out {
    to {
      background-color: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
    }
  }
</style>
