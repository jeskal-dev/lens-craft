---
import { Icon } from "astro-icon/components";
import Button from "../ui/button.astro";
import ToggleThemeButton from "../ui/toggle-theme-button.astro";

const { pathname } = Astro.url;
const normalizedPathname = pathname.replace(/\/$/, "");

const navLinks = [
  { href: "/", label: "Inicio" },
  { href: "/gallery", label: "Portafolio" },
  { href: "/services", label: "Servicios" },
  { href: "/about", label: "Sobre MÃ­" },
  { href: "/contact", label: "Contacto" },
];

const isActive = (href: string) => {
  if (href === "/" && (normalizedPathname === "" || normalizedPathname === "/"))
    return true;
  return normalizedPathname.startsWith(href) && href !== "/";
};
---

<header
  id="header"
  class="fixed top-0 w-full z-50 transition-all duration-500 pt-4 md:pt-6 group/header flex justify-center"
>
  <!-- Floating Pill Container -->
  <div
    class="relative flex items-center justify-between px-6 h-14 md:h-16 w-[95%] max-w-6xl rounded-2xl md:rounded-full bg-background/60 backdrop-blur-xl border border-white/10 shadow-lg shadow-black/5 transition-all duration-500 group-[.is-scrolled]/header:h-12 md:group-[.is-scrolled]/header:h-14 group-[.is-scrolled]/header:max-w-4xl"
  >
    <!-- Logo -->
    <a href="/" class="flex items-center gap-2 group/logo relative z-50">
      <div
        class="w-8 h-8 md:w-9 md:h-9 flex items-center justify-center bg-primary rounded-lg md:rounded-xl overflow-hidden shadow-lg shadow-primary/20 transition-all duration-500 group-hover/logo:rotate-12 group-hover/logo:scale-110"
      >
        <Icon
          name="lucide:camera"
          class="w-4 h-4 md:w-5 md:h-5 text-primary-foreground"
        />
      </div>
      <span
        class="text-lg md:text-xl font-serif font-bold tracking-tighter text-foreground"
      >
        LensCraft
      </span>
    </a>

    <!-- Desktop Navigation -->
    <nav class="hidden lg:flex items-center gap-1">
      {
        navLinks.map((link) => {
          const active = isActive(link.href);
          return (
            <a
              href={link.href}
              class={`relative px-3 py-1.5 text-xs font-bold uppercase tracking-wider transition-colors duration-300 group/link ${
                active
                  ? "text-primary"
                  : "text-muted-foreground hover:text-foreground"
              }`}
            >
              {link.label}
              <span
                class={`absolute bottom-0 left-3 right-3 h-0.5 bg-primary transition-transform duration-300 origin-center ${
                  active
                    ? "scale-x-100"
                    : "scale-x-0 group-hover/link:scale-x-100"
                }`}
              />
            </a>
          );
        })
      }
    </nav>

    <!-- Action Buttons -->
    <div class="flex items-center gap-2 relative z-50">
      <div class="hidden sm:flex items-center gap-2">
        <ToggleThemeButton />
      </div>

      <Button
        href="/contact"
        variant="primary"
        size="sm"
        rounded="full"
        class="hidden md:inline-flex"
      >
        Reservar
      </Button>

      <!-- Mobile Menu Toggle -->
      <button
        id="menu-toggle"
        class="lg:hidden p-2 rounded-xl text-muted-foreground hover:text-primary transition-all duration-300 active:scale-90"
        aria-label="Toggle menu"
      >
        <Icon
          name="lucide:menu"
          class="w-6 h-6 block group-[.menu-open]/header:hidden"
        />
        <Icon
          name="lucide:x"
          class="w-6 h-6 hidden group-[.menu-open]/header:block"
        />
      </button>
    </div>
  </div>

  <!-- Mobile Navigation Overlay (Kept mostly same but adjusted for new header) -->
  <div
    id="mobile-nav"
    class="lg:hidden fixed inset-0 bg-background/95 backdrop-blur-2xl -z-10 -translate-y-full transition-transform duration-500 ease-in-out opacity-0 group-[.menu-open]/header:translate-y-0 group-[.menu-open]/header:opacity-100"
  >
    <nav
      class="flex flex-col items-center justify-center h-full gap-8 px-6 pt-20"
    >
      {
        navLinks.map((link, index) => {
          const active = isActive(link.href);
          return (
            <a
              href={link.href}
              class={`text-3xl font-serif font-bold transition-colors duration-300 motion-safe:translate-y-10 motion-safe:opacity-0 group-[.menu-open]/header:motion-safe:translate-y-0 group-[.menu-open]/header:motion-safe:opacity-100 ${
                active ? "text-primary" : "text-foreground hover:text-primary"
              }`}
              style={`transition-delay: ${index * 100 + 200}ms`}
            >
              {link.label}
            </a>
          );
        })
      }
      <div class="w-full h-px bg-border/50 max-w-xs mt-4"></div>
      <div class="flex flex-col items-center gap-6 mt-4 w-full max-w-xs">
        <div class="flex items-center justify-between w-full">
          <span class="text-muted-foreground font-medium">Tema</span>
          <ToggleThemeButton />
        </div>
        <Button href="/contact" fullWidth size="lg" rounded="lg">
          Reservar ahora
        </Button>
      </div>
    </nav>
  </div>
</header>

<script>
  function initHeader() {
    const header = document.getElementById("header");
    const menuToggle = document.getElementById("menu-toggle");
    const mobileNav = document.getElementById("mobile-nav");

    const handleScroll = () => {
      if (window.scrollY > 10) {
        header?.classList.add("is-scrolled");
      } else {
        header?.classList.remove("is-scrolled");
      }
    };

    window.addEventListener("scroll", handleScroll);
    handleScroll();

    menuToggle?.addEventListener("click", () => {
      header?.classList.toggle("menu-open");
      const isOpen = header?.classList.contains("menu-open");
      document.body.style.overflow = isOpen ? "hidden" : "";
    });

    mobileNav?.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        header?.classList.remove("menu-open");
        document.body.style.overflow = "";
      });
    });
  }

  initHeader();
  document.addEventListener("astro:after-swap", initHeader);
</script>

<style>
  #mobile-nav a {
    transition:
      transform 0.6s cubic-bezier(0.16, 1, 0.3, 1),
      opacity 0.6s ease-out,
      color 0.3s ease;
  }
</style>
