---
import GalleryGrid from "../components/sections/gallery/grid.astro";
import GalleryHeader from "../components/sections/gallery/header.astro";
import Layout from "../components/layouts/layout.astro";

import { getCollection } from "astro:content";

const works = await getCollection("gallery");
const sortedWorks = works.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const categories = [
  "todos",
  ...new Set(works.map((work) => work.data.category)),
];

const categoryLabels: Record<string, string> = {
  todos: "Todos",
  bodas: "Bodas",
  retratos: "Retratos",
  paisajes: "Paisajes",
  editorial: "Editorial",
};

const title = "Galería";
const description = "Explora nuestra colección de momentos capturados.";
---

<Layout title={title} description={description}>
  <section
    id="gallery-page"
    class="relative pb-28 md:pb-32 bg-background overflow-hidden pt-28 md:pt-32"
  >
    <div
      class="pointer-events-none absolute inset-x-0 -top-40 -z-10 h-80 bg-radial from-primary/15 via-background to-background opacity-80"
      aria-hidden="true"
    >
    </div>

    <div class="container mx-auto px-6 space-y-12 md:space-y-16">
      <GalleryHeader categories={categories} categoryLabels={categoryLabels} />
      <GalleryGrid works={sortedWorks} categoryLabels={categoryLabels} />
    </div>
  </section>

  <script>
    import { startTransition } from "../helpers/start-transition";

    function initGalleryFiltering() {
      const root = document.getElementById("gallery-page");
      if (!root) return;

      const filterButtons = root.querySelectorAll<HTMLElement>("[data-filter]");
      const items = root.querySelectorAll<HTMLElement>("[data-gallery-item]");

      let currentFilter = "todos";

      const updateFilterButtons = () => {
        filterButtons.forEach((button) => {
          const filter = (button as HTMLElement).dataset.filter ?? "todos";
          button.setAttribute(
            "aria-pressed",
            filter === currentFilter ? "true" : "false"
          );
        });
      };

      const applyFilter = (category: string) => {
        currentFilter = category;

        startTransition(() => {
          items.forEach((item) => {
            const itemCategory = item.dataset.category ?? "";
            const shouldShow =
              category === "todos" || itemCategory === category;

            // Use data-hidden for the modal navigation to know which items are visible
            item.dataset.hidden = `${!shouldShow}`;

            if (shouldShow) {
              item.style.display = "";
              item.style.opacity = "1";
              item.style.transform = "scale(1)";
            } else {
              item.style.opacity = "0";
              item.style.transform = "scale(0.95)";
              setTimeout(() => {
                if (item.dataset.hidden === "true") item.style.display = "none";
              }, 300);
            }
          });

          updateFilterButtons();
        });
      };

      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          applyFilter(button.dataset.filter ?? "todos");
        });
      });

      // Initial state
      applyFilter("todos");
    }

    initGalleryFiltering();
    document.addEventListener("astro:after-swap", initGalleryFiltering);
  </script>
</Layout>
